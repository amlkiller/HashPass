<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>HashPass Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'system-ui', '-apple-system', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'SF Mono', 'Monaco', 'Cascadia Code', 'Consolas', 'monospace'],
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="/static/css/custom.css">
    <link rel="stylesheet" href="/static/admin/css/admin.css">
</head>
<body class="font-sans bg-[var(--bg-primary)] text-[var(--text-primary)] leading-relaxed min-h-screen transition-colors duration-300">

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Login View -->
    <div id="login-view" class="flex items-center justify-center min-h-screen p-4" style="display:flex;">
        <div class="login-card">
            <div class="flex items-center gap-3 mb-1">
                <div class="w-8 h-8 rounded-lg bg-[var(--accent-subtle)] border border-[var(--border-accent)] flex items-center justify-center">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                </div>
                <h1 class="gradient-text">HashPass Admin</h1>
            </div>
            <p>Enter admin token to continue</p>
            <input type="password" id="login-token" class="login-input" placeholder="Admin Token" autocomplete="off">
            <button class="login-btn" onclick="adminLogin()">Login</button>
            <div id="login-error" class="login-error"></div>
        </div>
    </div>

    <!-- Admin View -->
    <div id="admin-view" class="flex flex-col min-h-screen" style="display:none;">
        <!-- Header -->
        <header class="flex items-center justify-between px-4 sm:px-6 py-3 border-b border-[var(--border-color)] bg-[var(--glass-bg)] backdrop-blur-sm">
            <div class="flex items-center gap-3">
                <div class="w-7 h-7 rounded-lg bg-[var(--accent-subtle)] border border-[var(--border-accent)] flex items-center justify-center">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                </div>
                <span class="text-base font-bold gradient-text">HashPass Admin</span>
            </div>
            <div class="flex items-center gap-2">
                <!-- Theme Switcher -->
                <section class="flex gap-1 p-0.5 bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-lg">
                    <button class="theme-btn" data-theme="light" title="Light" style="width:1.75rem;height:1.75rem;">
                        <svg width="12" height="12" viewBox="0 0 16 16" fill="none">
                            <circle cx="8" cy="8" r="3" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M8 1V3M8 13V15M15 8H13M3 8H1M12.5 3.5L11 5M5 11L3.5 12.5M12.5 12.5L11 11M5 5L3.5 3.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                    </button>
                    <button class="theme-btn" data-theme="system" title="System" style="width:1.75rem;height:1.75rem;">
                        <svg width="12" height="12" viewBox="0 0 16 16" fill="none">
                            <rect x="2" y="3" width="12" height="9" rx="1" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M2 9H14" stroke="currentColor" stroke-width="1.5"/>
                        </svg>
                    </button>
                    <button class="theme-btn active" data-theme="dark" title="Dark" style="width:1.75rem;height:1.75rem;">
                        <svg width="12" height="12" viewBox="0 0 16 16" fill="none">
                            <path d="M14 8.5C13.5 11.5 10.5 14 7 14C3.5 14 1 11.5 1 8C1 4.5 3.5 2 7 2C7.5 2 8 2.1 8.5 2.2C7 3.5 6 5.5 6 8C6 10.5 7.5 13 10 14C11.5 13.5 13 12 14 10.5V8.5Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </section>
                <button class="admin-btn" onclick="adminLogout()" style="font-size:0.75rem;padding:0.375rem 0.75rem;">Logout</button>
            </div>
        </header>

        <!-- Tabs -->
        <nav class="px-4 sm:px-6 pt-4">
            <div class="admin-tabs">
                <button class="admin-tab active" data-tab="dashboard" onclick="switchTab('dashboard')">Dashboard</button>
                <button class="admin-tab" data-tab="params" onclick="switchTab('params')">Parameters</button>
                <button class="admin-tab" data-tab="logs" onclick="switchTab('logs')">Logs</button>
                <button class="admin-tab" data-tab="operations" onclick="switchTab('operations')">Operations</button>
            </div>
        </nav>

        <!-- Tab Content -->
        <main class="admin-content flex-1 overflow-y-auto px-4 sm:px-6 py-4">

            <!-- ===== Dashboard Tab ===== -->
            <div class="tab-panel" data-panel="dashboard" style="display:block;">
                <!-- Stat Cards -->
                <div class="stat-grid mb-4">
                    <div class="stat-card">
                        <div class="stat-label">Active Miners</div>
                        <div class="stat-value accent" id="stat-miners">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Connections</div>
                        <div class="stat-value" id="stat-connections">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Network Hashrate</div>
                        <div class="stat-value success" id="stat-hashrate">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Difficulty</div>
                        <div class="stat-value warning" id="stat-difficulty">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Banned IPs</div>
                        <div class="stat-value" id="stat-banned" style="color:var(--danger,#ef4444);">0</div>
                    </div>
                </div>

                <!-- Puzzle Info -->
                <div class="param-card mb-4">
                    <h3>Puzzle Info</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                        <div>
                            <div class="text-[0.6875rem] text-[var(--text-tertiary)] font-semibold uppercase mb-1">Seed</div>
                            <div class="font-mono text-xs text-[var(--text-secondary)]" id="info-seed">--</div>
                        </div>
                        <div>
                            <div class="text-[0.6875rem] text-[var(--text-tertiary)] font-semibold uppercase mb-1">Mining Time</div>
                            <div class="font-mono text-xs text-[var(--text-secondary)]" id="info-mining-time">--:--:--</div>
                        </div>
                        <div>
                            <div class="text-[0.6875rem] text-[var(--text-tertiary)] font-semibold uppercase mb-1">Last Solve</div>
                            <div class="font-mono text-xs text-[var(--text-secondary)]" id="info-last-solve">--</div>
                        </div>
                        <div>
                            <div class="text-[0.6875rem] text-[var(--text-tertiary)] font-semibold uppercase mb-1">Status</div>
                            <div class="font-mono text-xs font-bold" id="info-mining-status" style="color:var(--text-tertiary)">--</div>
                        </div>
                    </div>
                </div>

                <!-- Miners Table -->
                <div class="param-card">
                    <h3>Miners</h3>
                    <div class="admin-table-wrap">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>IP</th>
                                    <th>Hashrate</th>
                                    <th>Last Seen</th>
                                    <th style="text-align:center;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="miners-tbody">
                                <tr><td colspan="4" style="text-align:center;color:var(--text-tertiary);padding:1.5rem;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Banned IPs Table -->
                <div class="param-card">
                    <h3>Banned IPs</h3>
                    <div class="admin-table-wrap">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>IP</th>
                                    <th style="text-align:center;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="blacklist-tbody">
                                <tr><td colspan="2" style="text-align:center;color:var(--text-tertiary);padding:1.5rem;">No banned IPs</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ===== Parameters Tab ===== -->
            <div class="tab-panel" data-panel="params" style="display:none;">
                <div class="flex flex-col gap-4">
                    <!-- Difficulty -->
                    <div class="param-card">
                        <h3>Difficulty</h3>
                        <div class="param-row">
                            <label>Current</label>
                            <input type="number" class="param-input" id="param-difficulty" min="1" max="32">
                        </div>
                        <div class="param-row">
                            <label>Min</label>
                            <input type="number" class="param-input" id="param-min-difficulty" min="1" max="32">
                        </div>
                        <div class="param-row">
                            <label>Max</label>
                            <input type="number" class="param-input" id="param-max-difficulty" min="1" max="32">
                        </div>
                        <button class="admin-btn primary" style="align-self:flex-start;" onclick="applyDifficulty()">Apply</button>
                    </div>

                    <!-- Target Time -->
                    <div class="param-card">
                        <h3>Target Solve Time (seconds)</h3>
                        <div class="param-row">
                            <label>Min</label>
                            <input type="number" class="param-input" id="param-target-min" min="1">
                        </div>
                        <div class="param-row">
                            <label>Max</label>
                            <input type="number" class="param-input" id="param-target-max" min="1">
                        </div>
                        <button class="admin-btn primary" style="align-self:flex-start;" onclick="applyTargetTime()">Apply</button>
                    </div>

                    <!-- Argon2 -->
                    <div class="param-card">
                        <h3>Argon2 Parameters</h3>
                        <div class="warning-banner">Changing Argon2 parameters requires miners to re-fetch puzzle config. Active mining sessions will produce invalid hashes.</div>
                        <div class="param-row">
                            <label>Time Cost</label>
                            <input type="number" class="param-input" id="param-time-cost" min="1" max="10">
                        </div>
                        <div class="param-row">
                            <label>Memory (KB)</label>
                            <input type="number" class="param-input" id="param-memory-cost" min="1024" max="1048576" style="width:150px;">
                        </div>
                        <div class="param-row">
                            <label>Parallelism</label>
                            <input type="number" class="param-input" id="param-parallelism" min="1" max="8">
                        </div>
                        <button class="admin-btn primary" style="align-self:flex-start;" onclick="applyArgon2()">Apply</button>
                    </div>

                    <!-- Worker Count -->
                    <div class="param-card">
                        <h3>Frontend Worker Count</h3>
                        <div class="param-row">
                            <label>Workers</label>
                            <input type="number" class="param-input" id="param-worker-count" min="1" max="32">
                        </div>
                        <button class="admin-btn primary" style="align-self:flex-start;" onclick="applyWorkerCount()">Apply</button>
                    </div>
                </div>
            </div>

            <!-- ===== Logs Tab ===== -->
            <div class="tab-panel" data-panel="logs" style="display:none;">
                <div class="flex flex-col gap-4">
                    <!-- Search & File Selector -->
                    <div class="search-bar">
                        <input type="text" class="search-input" id="log-search-input" placeholder="Search (visitor_id, invite_code, IP...)" onkeydown="if(event.key==='Enter')_logsSearch()">
                        <select class="file-select" id="log-file-select" onchange="_logsFileChange()">
                            <option>verify.json</option>
                        </select>
                        <button class="admin-btn primary" onclick="_logsSearch()">Search</button>
                    </div>

                    <!-- Stats Summary -->
                    <div id="log-stats-summary" class="flex gap-4 flex-wrap text-xs text-[var(--text-secondary)] font-medium"></div>

                    <!-- Logs Table -->
                    <div class="admin-table-wrap">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Invite Code</th>
                                    <th>Visitor ID</th>
                                    <th>IP</th>
                                    <th>Diff</th>
                                    <th>Solve Time</th>
                                    <th>Adjustment</th>
                                </tr>
                            </thead>
                            <tbody id="logs-tbody">
                                <tr><td colspan="7" style="text-align:center;color:var(--text-tertiary);padding:1.5rem;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination" id="logs-pagination"></div>
                </div>
            </div>

            <!-- ===== Operations Tab ===== -->
            <div class="tab-panel" data-panel="operations" style="display:none;">
                <div class="flex flex-col gap-4">
                    <div class="op-card">
                        <h3>Force Reset Puzzle</h3>
                        <p>Generate a new seed immediately. All current mining progress will be lost.</p>
                        <button class="admin-btn warning" style="align-self:flex-start;" onclick="opResetPuzzle()">Reset Puzzle</button>
                    </div>

                    <div class="op-card">
                        <h3>Kick All Miners</h3>
                        <p>Disconnect all WebSocket connections. Miners will need to reconnect and re-verify.</p>
                        <button class="admin-btn danger" style="align-self:flex-start;" onclick="opKickAll()">Kick All</button>
                    </div>

                    <div class="op-card">
                        <h3>Clear All Sessions</h3>
                        <p>Clear all session tokens. Users will need to pass Turnstile verification again.</p>
                        <button class="admin-btn warning" style="align-self:flex-start;" onclick="opClearSessions()">Clear Sessions</button>
                    </div>

                    <div class="op-card">
                        <h3>Ban IP</h3>
                        <p>Ban a specific IP address. The IP will be disconnected and blocked from reconnecting.</p>
                        <div class="flex gap-2 items-center" style="align-self:flex-start;">
                            <input type="text" class="param-input" id="op-ban-ip-input" placeholder="e.g. 192.168.1.100" style="width:200px;">
                            <button class="admin-btn danger" onclick="opBanIp()">Ban</button>
                        </div>
                    </div>

                    <div class="op-card">
                        <h3>Unban IP</h3>
                        <p>Remove an IP address from the blacklist, allowing it to reconnect.</p>
                        <div class="flex gap-2 items-center" style="align-self:flex-start;">
                            <input type="text" class="param-input" id="op-unban-ip-input" placeholder="e.g. 192.168.1.100" style="width:200px;">
                            <button class="admin-btn warning" onclick="opUnbanIp()">Unban</button>
                        </div>
                    </div>

                    <div class="op-card">
                        <h3>HMAC Secret</h3>
                        <p>Set a specific HMAC key (hex) or leave empty to generate a random 256-bit key.</p>
                        <div class="danger-banner">This will invalidate ALL previously issued invite codes. This action cannot be undone.</div>
                        <div class="flex gap-2 items-center" style="align-self:flex-start;">
                            <input type="text" class="param-input" id="op-hmac-input" placeholder="hex (empty = random)" style="width:280px;">
                            <button class="admin-btn danger" onclick="opRegenerateHmac()">Apply</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module" src="/static/admin/app.js"></script>
</body>
</html>
