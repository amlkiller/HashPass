<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>HashPass 管理面板</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'system-ui', '-apple-system', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'SF Mono', 'Monaco', 'Cascadia Code', 'Consolas', 'monospace'],
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="/static/css/custom.css">
    <link rel="stylesheet" href="/static/admin/css/admin.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="font-sans bg-[var(--bg-primary)] text-[var(--text-primary)] leading-relaxed min-h-screen transition-colors duration-300">

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Login View -->
    <div id="login-view" class="flex items-center justify-center min-h-screen p-4" style="display:flex;">
        <div class="login-card">
            <div class="flex items-center gap-3 mb-1">
                <div class="w-8 h-8 rounded-lg bg-[var(--accent-subtle)] border border-[var(--border-accent)] flex items-center justify-center">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                </div>
                <h1 class="gradient-text">HashPass Admin</h1>
            </div>
            <p>输入管理员令牌以继续</p>
            <input type="password" id="login-token" class="login-input" placeholder="管理员令牌" autocomplete="off">
            <button class="login-btn" onclick="adminLogin()">登录</button>
            <div id="login-error" class="login-error"></div>
        </div>
    </div>

    <!-- Admin View -->
    <div id="admin-view" class="flex flex-col min-h-screen" style="display:none;">
        <!-- Header -->
        <header class="flex items-center justify-between px-4 sm:px-6 py-3 border-b border-[var(--border-color)] bg-[var(--glass-bg)] backdrop-blur-sm">
            <div class="flex items-center gap-3">
                <div class="w-7 h-7 rounded-lg bg-[var(--accent-subtle)] border border-[var(--border-accent)] flex items-center justify-center">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                </div>
                <span class="text-base font-bold gradient-text">HashPass Admin</span>
            </div>
            <div class="flex items-center gap-2">
                <!-- Theme Switcher -->
                <section class="flex gap-1 p-0.5 bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-lg">
                    <button class="theme-btn" data-theme="light" title="浅色" style="width:1.75rem;height:1.75rem;">
                        <svg width="12" height="12" viewBox="0 0 16 16" fill="none">
                            <circle cx="8" cy="8" r="3" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M8 1V3M8 13V15M15 8H13M3 8H1M12.5 3.5L11 5M5 11L3.5 12.5M12.5 12.5L11 11M5 5L3.5 3.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                    </button>
                    <button class="theme-btn" data-theme="system" title="跟随系统" style="width:1.75rem;height:1.75rem;">
                        <svg width="12" height="12" viewBox="0 0 16 16" fill="none">
                            <rect x="2" y="3" width="12" height="9" rx="1" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M2 9H14" stroke="currentColor" stroke-width="1.5"/>
                        </svg>
                    </button>
                    <button class="theme-btn active" data-theme="dark" title="深色" style="width:1.75rem;height:1.75rem;">
                        <svg width="12" height="12" viewBox="0 0 16 16" fill="none">
                            <path d="M14 8.5C13.5 11.5 10.5 14 7 14C3.5 14 1 11.5 1 8C1 4.5 3.5 2 7 2C7.5 2 8 2.1 8.5 2.2C7 3.5 6 5.5 6 8C6 10.5 7.5 13 10 14C11.5 13.5 13 12 14 10.5V8.5Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </section>
                <!-- WS Status Indicator -->
                <div class="flex items-center gap-1.5 px-2 py-1 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border-color)]">
                    <span id="ws-status-dot" style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#6b7280;flex-shrink:0;transition:background 0.3s;"></span>
                    <span id="ws-status-text" style="font-size:0.6875rem;font-weight:500;color:var(--text-tertiary);white-space:nowrap;">断开</span>
                </div>
                <button class="admin-btn" onclick="adminLogout()" style="font-size:0.75rem;padding:0.375rem 0.75rem;">登出</button>
            </div>
        </header>

        <!-- Tabs -->
        <nav class="px-4 sm:px-6 pt-4">
            <div class="admin-tabs">
                <button class="admin-tab active" data-tab="dashboard" onclick="switchTab('dashboard')">仪表盘</button>
                <button class="admin-tab" data-tab="params" onclick="switchTab('params')">参数</button>
                <button class="admin-tab" data-tab="logs" onclick="switchTab('logs')">邀请码</button>
                <button class="admin-tab" data-tab="applogs" onclick="switchTab('applogs')">日志</button>
                <button class="admin-tab" data-tab="operations" onclick="switchTab('operations')">操作</button>
            </div>
        </nav>

        <!-- Tab Content -->
        <main class="admin-content flex-1 overflow-y-auto px-4 sm:px-6 py-4">

            <!-- ===== Dashboard Tab ===== -->
            <div class="tab-panel" data-panel="dashboard" style="display:block;">
                <!-- Stat Cards -->
                <div class="stat-grid mb-4">
                    <div class="stat-card">
                        <div class="stat-label">活跃矿工</div>
                        <div class="stat-value accent" id="stat-miners">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">连接数</div>
                        <div class="stat-value" id="stat-connections">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">全网算力</div>
                        <div class="stat-value success" id="stat-hashrate">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">上次求解用时</div>
                        <div class="stat-value" id="stat-last-solve" style="color:var(--accent);">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">平均求解用时</div>
                        <div class="stat-value" id="stat-avg-solve" style="color:var(--accent);">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">挖矿时间</div>
                        <div class="stat-value" id="info-mining-time" style="font-family:'JetBrains Mono',monospace;">--:--:--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">状态</div>
                        <div class="stat-value" id="info-mining-status" style="color:var(--text-tertiary);">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">难度</div>
                        <div class="stat-value warning" id="stat-difficulty">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">封禁 IP</div>
                        <div class="stat-value" id="stat-banned" style="color:var(--danger,#ef4444);">0</div>
                    </div>
                    <div class="stat-card" style="grid-column: span 2;">
                        <div class="stat-label">种子</div>
                        <div class="stat-value" id="info-seed" style="font-family:'JetBrains Mono',monospace;font-size:0.875rem;word-break:break-all;">--</div>
                    </div>
                </div>

                <!-- Trend Charts -->
                <div class="param-card mb-4">
                    <h3>趋势图</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <div class="text-[0.6875rem] text-[var(--text-tertiary)] font-semibold uppercase mb-2">全网算力（H/s）</div>
                            <canvas id="chart-hashrate" height="120"></canvas>
                        </div>
                        <div>
                            <div class="text-[0.6875rem] text-[var(--text-tertiary)] font-semibold uppercase mb-2">上次求解用时（秒）</div>
                            <canvas id="chart-solve-time" height="120"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Miners Table -->
                <div class="param-card mb-4">
                    <h3>矿工</h3>
                    <div class="admin-table-wrap">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>IP</th>
                                    <th>算力</th>
                                    <th>在线时长</th>
                                    <th>最后活跃</th>
                                    <th style="text-align:center;">操作</th>
                                </tr>
                            </thead>
                            <tbody id="miners-tbody">
                                <tr><td colspan="5" style="text-align:center;color:var(--text-tertiary);padding:1.5rem;">加载中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Banned IPs Table -->
                <div class="param-card">
                    <h3>封禁 IP</h3>
                    <div class="admin-table-wrap">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>IP</th>
                                    <th style="text-align:center;">操作</th>
                                </tr>
                            </thead>
                            <tbody id="blacklist-tbody">
                                <tr><td colspan="2" style="text-align:center;color:var(--text-tertiary);padding:1.5rem;">暂无封禁 IP</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ===== Parameters Tab ===== -->
            <div class="tab-panel" data-panel="params" style="display:none;">
                <div class="param-grid">
                    <!-- Difficulty -->
                    <div class="param-card">
                        <h3>难度</h3>
                        <div class="param-row">
                            <label>当前</label>
                            <input type="number" class="param-input" id="param-difficulty" min="1" max="32">
                        </div>
                        <div class="param-row">
                            <label>最小</label>
                            <input type="number" class="param-input" id="param-min-difficulty" min="1" max="32">
                        </div>
                        <div class="param-row">
                            <label>最大</label>
                            <input type="number" class="param-input" id="param-max-difficulty" min="1" max="32">
                        </div>
                        <button class="admin-btn primary" style="align-self:flex-start;" onclick="applyDifficulty()">应用</button>
                    </div>

                    <!-- Target Time -->
                    <div class="param-card">
                        <h3>目标求解时间（秒）</h3>
                        <div class="param-row">
                            <label>目标时间</label>
                            <input type="number" class="param-input" id="param-target-time" min="1">
                        </div>
                        <div class="param-row">
                            <label>超时时间</label>
                            <input type="number" class="param-input" id="param-target-timeout" min="1">
                        </div>
                        <button class="admin-btn primary" style="align-self:flex-start;" onclick="applyTargetTime()">应用</button>
                    </div>

                    <!-- Argon2 -->
                    <div class="param-card">
                        <h3>Argon2 参数</h3>
                        <div class="warning-banner">修改 Argon2 参数后，矿工需要重新获取谜题配置。当前挖矿会话将产生无效哈希。</div>
                        <div class="param-row">
                            <label>时间开销</label>
                            <input type="number" class="param-input" id="param-time-cost" min="1">
                        </div>
                        <div class="param-row">
                            <label>内存 (KB)</label>
                            <input type="number" class="param-input" id="param-memory-cost" min="8" style="width:150px;">
                        </div>
                        <div class="param-row">
                            <label>并行度</label>
                            <input type="number" class="param-input" id="param-parallelism" min="1">
                        </div>
                        <button class="admin-btn primary" style="align-self:flex-start;" onclick="applyArgon2()">应用</button>
                    </div>

                    <!-- Worker Count -->
                    <div class="param-card">
                        <h3>前端 Worker 数量</h3>
                        <div class="param-row">
                            <label>Worker 数</label>
                            <input type="number" class="param-input" id="param-worker-count" min="1" max="32">
                        </div>
                        <button class="admin-btn primary" style="align-self:flex-start;" onclick="applyWorkerCount()">应用</button>
                    </div>

                    <!-- Max Nonce Speed -->
                    <div class="param-card">
                        <h3>计算速度限制</h3>
                        <div class="warning-banner">设置客户端提交时允许的最大计算速度（nonce / 求解时间）。超出阈值的提交将被拒绝。设为 0 可禁用此检查。</div>
                        <div class="param-row">
                            <label>最大速度（nonce/s）</label>
                            <input type="number" class="param-input" id="param-max-nonce-speed" min="0" step="100" placeholder="0 = 禁用" style="width:150px;">
                        </div>
                        <button class="admin-btn primary" style="align-self:flex-start;" onclick="applyMaxNonceSpeed()">应用</button>
                    </div>
                </div>
            </div>

            <!-- ===== Logs Tab ===== -->
            <div class="tab-panel" data-panel="logs" style="display:none;">
                <div class="flex flex-col gap-4">
                    <!-- Search & File Selector -->
                    <div class="search-bar">
                        <input type="text" class="search-input" id="log-search-input" placeholder="搜索（visitor_id、邀请码、IP...）" onkeydown="if(event.key==='Enter')_logsSearch()">
                        <select class="file-select" id="log-file-select" onchange="_logsFileChange()">
                            <option>verify.json</option>
                        </select>
                        <button class="admin-btn primary" onclick="_logsSearch()">搜索</button>
                    </div>

                    <!-- Stats Summary -->
                    <div id="log-stats-summary" class="flex gap-4 flex-wrap text-xs text-[var(--text-secondary)] font-medium"></div>

                    <!-- Logs Table -->
                    <div class="admin-table-wrap">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>邀请码</th>
                                    <th>访客 ID</th>
                                    <th>IP</th>
                                    <th>难度</th>
                                    <th>求解时间</th>
                                    <th>调整</th>
                                </tr>
                            </thead>
                            <tbody id="logs-tbody">
                                <tr><td colspan="7" style="text-align:center;color:var(--text-tertiary);padding:1.5rem;">加载中...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination" id="logs-pagination"></div>
                </div>
            </div>

            <!-- ===== App Logs Tab ===== -->
            <div class="tab-panel" data-panel="applogs" style="display:none;">
                <div class="flex flex-col gap-4">
                    <!-- Controls -->
                    <div class="search-bar">
                        <input type="text" class="search-input" id="applog-search-input" placeholder="搜索日志内容..." onkeydown="if(event.key==='Enter')_appLogsSearch()">
                        <select class="file-select" id="applog-file-select" onchange="_appLogsFileChange()">
                            <option value="hashpass.log">hashpass.log</option>
                        </select>
                        <select class="file-select" id="applog-level-select" onchange="_appLogsLevelChange()" style="width:auto;">
                            <option value="">ALL</option>
                            <option value="DEBUG">DEBUG</option>
                            <option value="INFO">INFO</option>
                            <option value="WARNING">WARNING</option>
                            <option value="ERROR">ERROR</option>
                            <option value="CRITICAL">CRITICAL</option>
                        </select>
                        <button class="admin-btn primary" onclick="_appLogsSearch()">搜索</button>
                    </div>

                    <!-- Log Table -->
                    <div class="admin-table-wrap">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th style="width:3.5rem;text-align:right;">#</th>
                                    <th>日志内容</th>
                                </tr>
                            </thead>
                            <tbody id="applog-tbody">
                                <tr><td colspan="2" style="text-align:center;color:var(--text-tertiary);padding:1.5rem;">加载中...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination" id="applog-pagination"></div>
                </div>
            </div>

            <!-- ===== Operations Tab ===== -->
            <div class="tab-panel" data-panel="operations" style="display:none;">
                <div class="param-grid">
                    <div class="op-card">
                        <h3>强制重置谜题</h3>
                        <p>立即生成新种子。所有当前挖矿进度将丢失。</p>
                        <button class="admin-btn warning" style="align-self:flex-start;" onclick="opResetPuzzle()">重置谜题</button>
                    </div>

                    <div class="op-card">
                        <h3>踢出所有矿工</h3>
                        <p>断开所有 WebSocket 连接。矿工需要重新连接并重新验证。</p>
                        <button class="admin-btn danger" style="align-self:flex-start;" onclick="opKickAll()">全部踢出</button>
                    </div>

                    <div class="op-card">
                        <h3>清除所有会话</h3>
                        <p>清除所有会话令牌。用户需要重新通过 Turnstile 验证。</p>
                        <button class="admin-btn warning" style="align-self:flex-start;" onclick="opClearSessions()">清除会话</button>
                    </div>

                    <div class="op-card">
                        <h3>封禁 IP</h3>
                        <p>封禁指定 IP 地址。该 IP 将被断开连接并阻止重新连接。</p>
                        <div class="flex gap-2 items-center" style="align-self:flex-start;">
                            <input type="text" class="param-input" id="op-ban-ip-input" placeholder="例如 192.168.1.100" style="width:200px;">
                            <button class="admin-btn danger" onclick="opBanIp()">封禁</button>
                        </div>
                    </div>

                    <div class="op-card">
                        <h3>解封 IP</h3>
                        <p>将 IP 地址从黑名单中移除，允许其重新连接。</p>
                        <div class="flex gap-2 items-center" style="align-self:flex-start;">
                            <input type="text" class="param-input" id="op-unban-ip-input" placeholder="例如 192.168.1.100" style="width:200px;">
                            <button class="admin-btn warning" onclick="opUnbanIp()">解封</button>
                        </div>
                    </div>

                    <div class="op-card">
                        <h3>HMAC 密钥</h3>
                        <p>设置指定的 HMAC 密钥（十六进制），留空则随机生成 256 位密钥。</p>
                        <div class="danger-banner">此操作将使所有已签发的邀请码失效，且无法撤销。</div>
                        <div class="flex gap-2 items-center" style="align-self:flex-start;">
                            <input type="text" class="param-input" id="op-hmac-input" placeholder="十六进制（留空 = 随机）" style="width:280px;">
                            <button class="admin-btn danger" onclick="opRegenerateHmac()">应用</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module" src="/static/admin/app.js"></script>
</body>
</html>
