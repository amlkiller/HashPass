
# HashPass: The Atomic Hash-Lock Protocol

> "Ephemeral Puzzles. Memory-Hard Proofs."
> â€”â€” **ç¬æ—¶å“ˆå¸Œé”ï¼Œå†…å­˜çº§ç¡¬æ ¸éªŒè¯ï¼Œèµ¢å®¶é€šåƒã€‚**

**HashPass** æ˜¯ä¸€ä¸ªåŸºäº **Client Puzzlesï¼ˆå®¢æˆ·ç«¯è°œé¢˜ï¼‰** æ¶æ„çš„ç¡¬æ ¸é‚€è¯·ç åˆ†å‘ç³»ç»Ÿã€‚

å®ƒå½»åº•æ‘’å¼ƒäº†ä¼ ç»Ÿçš„æ•°æ®åº“çŠ¶æ€ç»´æŠ¤ï¼Œè½¬è€Œä½¿ç”¨ **Python å†…å­˜å…¨å±€çŠ¶æ€ + `asyncio.Lock**` æ¥ç»´æŠ¤ä¸€ä¸ªå…¨ç½‘å”¯ä¸€çš„ã€åŠ¨æ€é‡ç½®çš„åŸå­å“ˆå¸Œé”ã€‚ç³»ç»Ÿæ·±åº¦ç»“åˆ **ThumbmarkJS** è®¾å¤‡æŒ‡çº¹ä¸ **Argon2** å†…å­˜ç¡¬ä¾èµ–ç®—æ³•ï¼Œå¹¶å°† **Cloudflare Trace** ç½‘ç»œç‰¹å¾å¼ºåˆ¶æ··å…¥ç®—åŠ›è®¡ç®—è¿‡ç¨‹ï¼Œæ„å»ºäº†ä¸€ä¸ªæ— éœ€å¤–éƒ¨ç¼“å­˜ç»„ä»¶ï¼ˆNo Redisï¼‰ã€æŠ— ASICã€æŠ— GPUã€æŠ—äº‘æœåŠ¡å™¨é›†ç¾¤çš„ç»å¯¹å…¬å¹³ç«é€Ÿç¯å¢ƒã€‚

## ğŸŒŸ æ ¸å¿ƒç‰¹æ€§ (Features)

* **ğŸ§  å†…å­˜ç¡¬ä¾èµ– (Memory-Hard)**: é‡‡ç”¨ **Argon2id** ç®—æ³•ã€‚æŒ–çŸ¿ä¸ä»…æ¶ˆè€— CPUï¼Œå¿…é¡»å ç”¨ **64MB+ RAM**ã€‚è¿™ä½¿å¾—ä½é…äº‘æœåŠ¡å™¨ï¼ˆVPSï¼‰å’Œåƒµå°¸ç½‘ç»œæ— æ³•æ‰¹é‡å¹¶å‘ï¼Œå› ä¸ºå†…å­˜æˆæœ¬è¿œé«˜äº CPU æˆæœ¬ã€‚
* **ğŸ“ å…¨é“¾è·¯ç¯å¢ƒç»‘å®š**: ç®—åŠ›è®¡ç®—çš„ Salt å¼ºåˆ¶åŒ…å« `TraceData`ï¼ˆIP/ISPä¿¡æ¯ï¼‰ã€‚è¿™æ„å‘³ç€ç®—åŠ›æ— æ³•å¤–åŒ…â€”â€”é»‘å®¢æ— æ³•ç”¨é«˜æ€§èƒ½æœåŠ¡å™¨è®¡ç®—åï¼Œå†é€šè¿‡å»‰ä»·ä»£ç† IP æäº¤ï¼Œå› ä¸º IP ä¸åŒ¹é…ä¼šå¯¼è‡´æœåŠ¡ç«¯å“ˆå¸ŒéªŒè¯å¤±è´¥ã€‚
* **âš¡ å†…å­˜çº§åŸå­é” (In-Memory Atomic Lock)**: ç§»é™¤ Redisï¼Œåˆ©ç”¨ Python çš„ `asyncio.Lock` å®ç°æ¯«ç§’çº§äº’æ–¥ã€‚å…¨ç½‘äº‰å¤ºåŒä¸€ä¸ª Puzzle Seedã€‚ä¸€æ—¦æœ‰äººè§£å¼€ï¼ŒæœåŠ¡å™¨å†…å­˜ä¸­çš„ Seed ç«‹å³é‡ç½®ï¼Œå…¶ä»–äººçš„è®¡ç®—ç¬é—´ä½œåºŸã€‚
* **ğŸ†” ç¡¬ä»¶çº§æŒ‡çº¹**: é›†æˆ **ThumbmarkJS**ã€‚ç®—åŠ›ç»‘å®šç‰©ç†ç¡¬ä»¶ï¼ˆCanvas, Audio, Screenï¼‰ï¼Œæœ‰æ•ˆéåˆ¶â€œä¸€æœºå¤šå·â€ã€‚
* **ğŸ” é›¶å­˜å‚¨éšç§**: é‚€è¯·ç ç”±æœåŠ¡å™¨ HMAC ç­¾ååŠ¨æ€ç”Ÿæˆï¼Œä»…é€šè¿‡ç§æœ‰ HTTP å“åº”å‘æ”¾ï¼ŒæœåŠ¡ç«¯ä¸å­˜å‚¨ä»»ä½•ç”¨æˆ·æ•°æ®ã€‚

## ğŸ§© åè®®æ¶æ„ (The Protocol)

### 1. æ··åˆèº«ä»½è®¤è¯ (Hybrid Identity)

ä¸ºäº†ç¡®ä¿â€œä¸€äººä¸€æœºä¸€IPâ€ï¼Œæˆ‘ä»¬æ„å»ºäº†å¤šç»´åº¦çš„èº«ä»½ç›ï¼ˆSaltï¼‰ï¼Œå¹¶å°†åä½œå¼Šå‰ç½®ï¼š

* **Network Identity**: Cloudflare Trace (IP, Country, Data Center).
* **Device Identity**: Thumbmark Visitor ID (Based on Canvas, Audio, WebGL).

**åä½œå¼Šé€»è¾‘**ï¼š

* **ç¦æ­¢ç®—åŠ›ä»£æ‰“**ï¼šè®¡ç®—å“ˆå¸Œæ—¶æ··å…¥äº†å½“å‰ IP ç‰¹å¾ï¼Œè®¡ç®—ç«¯ IP å¿…é¡»ä¸æäº¤ç«¯ IP ä¸€è‡´ã€‚
* **æŒ‡çº¹æ¬ºè¯ˆæ£€æµ‹**ï¼šæœåŠ¡ç«¯éªŒè¯ Trace ä¿¡æ¯ä¸­çš„ IP æ˜¯å¦ä¸ HTTP è¯·æ±‚çš„çœŸå®è¿æ¥ IP åŒ¹é…ã€‚

### 2. åŠ¨æ€è°œé¢˜ (The Atomic Puzzle)

æœåŠ¡å™¨åœ¨å†…å­˜ä¸­ç»´æŠ¤å…¨å±€è°œé¢˜çŠ¶æ€ï¼š

```python
# Python Global State
CURRENT_PUZZLE = {
  "seed": "f8a9d2...",  # éšæœºç”Ÿæˆçš„ 32å­—èŠ‚ Hexï¼Œæ¯å½“æœ‰äººè·èƒœç«‹å³æ”¹å˜
  "difficulty": 4,      # ç›®æ ‡å“ˆå¸Œå‰ N ä½éœ€ä¸º 0
  "memory_cost": 65536  # è¦æ±‚å®¢æˆ·ç«¯åˆ†é… 64MB å†…å­˜
}

```

### 3. æŒ–æ˜ç®—æ³• (Algorithm: Argon2id)

çŸ¿å·¥ï¼ˆæµè§ˆå™¨ï¼‰å¿…é¡»åŠ è½½ WebAssembly æ¨¡å—æ‰§è¡Œä»¥ä¸‹è®¡ç®—ã€‚

**æ ¸å¿ƒå…¬å¼**:


* **TraceData**: Cloudflare æä¾›çš„åŸå§‹è¿æ¥ä¿¡æ¯ï¼ˆåŒ…å« IPï¼‰ã€‚
* **ç»‘å®šæ•ˆåº”**: å¿…é¡»åŒæ—¶æ»¡è¶³ â€œæ­£ç¡®çš„æ—¶é—´ (Seed)â€ + â€œæ­£ç¡®çš„è®¾å¤‡ (Thumbmark)â€ + â€œæ­£ç¡®çš„ç½‘ç»œç¯å¢ƒ (Trace)â€ï¼Œç®—åŠ›æ‰æœ‰æ•ˆã€‚

---

## ğŸ› ï¸ æŠ€æœ¯æ ˆ (Tech Stack)

### Frontend

* **UI**: Preact + Pico.css
* **Mining**: `hash-wasm` (High-performance Argon2 via WASM)
* **Fingerprinting**: `ThumbmarkJS`

### Backend

* **Language**: Python 3.9+
* **Framework**: FastAPI
* **Concurrency**: `asyncio` (ç”¨äºå¤„ç†åŸå­é”)
* **Crypto**: `argon2-cffi` (Python æ ‡å‡† Argon2 ç»‘å®š)
* **Storage**: **None** (çº¯å†…å­˜å˜é‡ï¼Œé‡å¯å³é‡ç½®)

---

## ğŸš€ å¿«é€Ÿå¼€å§‹ (Quick Start)

### 1. å‰ç«¯å®ç° (Miner Logic)

*ä½¿ç”¨ JavaScript (ESM)*

```javascript
import { getFingerprint } from '@thumbmarkjs/thumbmarkjs';
import { argon2id } from 'hash-wasm';

async function startRace() {
    // 1. è·å–è®¾å¤‡æŒ‡çº¹ (ç¡¬ä»¶ç»‘å®š)
    const fp = await getFingerprint();
    const visitorId = fp.hash;

    // 2. è·å–ç½‘ç»œç‰¹å¾ (ç½‘ç»œç»‘å®š) - å…³é”®æ­¥éª¤
    const traceData = await fetch('/cdn-cgi/trace').then(r => r.text());

    // 3. è·å–å½“å‰è°œé¢˜
    const puzzle = await fetch('/api/puzzle').then(r => r.json());

    // 4. å¼€å§‹å†…å­˜ç¡¬ä¾èµ–è®¡ç®— (å°† Trace æ··å…¥ Salt)
    const result = await mineArgon2(puzzle.seed, visitorId, traceData, puzzle.difficulty);
    
    // 5. æäº¤ç»“æœ
    await submit({ ...result, traceData }, visitorId);
}

// æŒ–çŸ¿æ ¸å¿ƒ
async function mineArgon2(seed, deviceId, traceData, difficulty) {
    let nonce = 0;
    
    // âš ï¸ æ„å»ºå…¨é“¾è·¯ç»‘å®š Salt
    // æ”»å‡»è€…è‹¥æƒ³ä½¿ç”¨ä»£ç†æäº¤ï¼Œå¿…é¡»å…ˆè·çŸ¥ä»£ç† IP çš„ TraceDataï¼Œä¸”å¿…é¡»åœ¨ä»£ç†æœºå™¨ä¸Šè¿ç®—
    const saltString = seed + deviceId + traceData;
    const salt = new TextEncoder().encode(saltString);
    
    while(true) {
        nonce++;
        const hash = await argon2id({
            password: nonce.toString(),
            salt: salt,
            memoryCost: 65536, // 64MB RAM
            timeCost: 3,
            outputType: 'hex'
        });
        
        if (hash.startsWith('0'.repeat(difficulty))) {
            return { nonce, hash };
        }
    }
}

```

### 2. æœåŠ¡ç«¯å®ç° (Verification Logic)

*ä½¿ç”¨ Python (FastAPI)*

```python
import asyncio
import secrets
from fastapi import FastAPI, Request, HTTPException
from pydantic import BaseModel
from argon2 import PasswordHasher, Type

app = FastAPI()

# --- å…¨å±€å†…å­˜çŠ¶æ€ & åŸå­é” ---
class SystemState:
    def __init__(self):
        self.lock = asyncio.Lock()
        self.current_seed = secrets.token_hex(16)
        # Argon2 é…ç½®: 64MB å†…å­˜, 3 è½®è¿­ä»£, å¹¶è¡Œåº¦ 1
        self.ph = PasswordHasher(
            time_cost=3, 
            memory_cost=65536, 
            parallelism=1, 
            hash_len=32, 
            type=Type.ID
        )

state = SystemState()

class Submission(BaseModel):
    visitorId: str
    nonce: int
    submittedSeed: str
    traceData: str

@app.get("/api/puzzle")
async def get_puzzle():
    return {
        "seed": state.current_seed,
        "difficulty": 4,
        "memory_cost": 65536
    }

@app.post("/api/verify")
async def verify(sub: Submission, request: Request):
    # 1. è·å–çœŸå® IP (Cloudflare Header)
    real_ip = request.headers.get("cf-connecting-ip")
    if not real_ip:
        # å¼€å‘ç¯å¢ƒå›é€€
        real_ip = request.client.host

    # 2. å®Œæ•´æ€§é£æ§ï¼šæ ¡éªŒæäº¤çš„ TraceData æ˜¯å¦å±äºå½“å‰è¯·æ±‚ IP
    if f"ip={real_ip}" not in sub.traceData:
        raise HTTPException(status_code=403, detail="Identity Mismatch (Trace/IP)")

    # 3. è¿›å…¥åŸå­é”ä¸´ç•ŒåŒº (Critical Section)
    async with state.lock:
        # 3.1 æ£€æŸ¥ Seed æ˜¯å¦è¿‡æœŸ
        if state.current_seed != sub.submittedSeed:
            raise HTTPException(status_code=409, detail="Too slow, puzzle reset")

        # 3.2 é‡å»º Salt (å¿…é¡»ä¸å‰ç«¯å®Œå…¨ä¸€è‡´)
        # Salt = Seed + DeviceID + TraceData
        salt_raw = (sub.submittedSeed + sub.visitorId + sub.traceData).encode('utf-8')
        
        # 3.3 éªŒè¯ Argon2 å“ˆå¸Œ
        # æ³¨æ„: argon2-cffi çš„ verify éœ€è¦å®Œæ•´çš„ hash å­—ç¬¦ä¸²ï¼Œ
        # è¿™é‡Œä¸ºäº†æ¼”ç¤ºç®€åŒ–äº†éªŒè¯é€»è¾‘ï¼Œå®é™…åº”é‡æ–°è®¡ç®— hash å¹¶å¯¹æ¯”å‰ç¼€
        try:
            # æ¨¡æ‹Ÿé‡æ–°è®¡ç®—å“ˆå¸Œ
            # å®é™…ç”Ÿäº§ä¸­å»ºè®®ä½¿ç”¨ low-level API ä»…è®¡ç®— hash é¿å…æŠ›å‡ºå¼‚å¸¸
            import argon2.low_level as alg
            
            raw_hash = alg.hash_secret_raw(
                secret=str(sub.nonce).encode('utf-8'),
                salt=salt_raw,
                time_cost=3,
                memory_cost=65536,
                parallelism=1,
                hash_len=32,
                type=alg.Type.ID
            )
            hash_hex = raw_hash.hex()
            
            # 3.4 æ£€æŸ¥éš¾åº¦ (å‰ N ä½ä¸º 0)
            if not hash_hex.startswith("0" * 4): # difficulty = 4
                raise HTTPException(status_code=400, detail="Invalid Hash Solution")
            
            # 4. è·èƒœå¤„ç†ï¼šç«‹å³é‡ç½® Seed
            state.current_seed = secrets.token_hex(16)
            
            # è¿”å›é‚€è¯·ç 
            return {"invite_code": f"WINNER-{secrets.token_urlsafe(8)}"}
            
        except Exception as e:
            raise HTTPException(status_code=500, detail=str(e))


```

---

## âš ï¸ å…³é”®éƒ¨ç½²æŒ‡å— (Deployment)

ç”±äºæˆ‘ä»¬ç§»é™¤äº† Redis å¹¶ä¾èµ– Python çš„**å†…å­˜å…¨å±€å˜é‡**æ¥ç»´æŠ¤åŸå­é”ï¼Œéƒ¨ç½²æ—¶å¿…é¡»éµå®ˆä»¥ä¸‹ä¸¥æ ¼é™åˆ¶ï¼š

1. **å•è¿›ç¨‹æ¨¡å¼ (Single Worker Only)**:
ä½ å¿…é¡»å¼ºåˆ¶ Uvicorn/Gunicorn ä»…ä½¿ç”¨ **1 ä¸ª Worker**ã€‚å¦‚æœæ˜¯å¤šè¿›ç¨‹æ¨¡å¼ï¼Œä¸åŒè¿›ç¨‹é—´çš„å†…å­˜ä¸å…±äº«ï¼Œä¼šå¯¼è‡´åŸå­é”å¤±æ•ˆï¼ˆç”¨æˆ· A è§£å¼€äº†è¿›ç¨‹ 1 çš„é”ï¼Œä½†è¿›ç¨‹ 2 çš„ç”¨æˆ·è¿˜åœ¨è·‘æ—§çš„ Seedï¼‰ã€‚
**å¯åŠ¨å‘½ä»¤**:
```bash
uvicorn main:app --host 0.0.0.0 --port 8000 --workers 1

```


2. **Cloudflare å¼ºä¾èµ–**:
æœ¬åè®®å¼ºä¾èµ– Cloudflare çš„ `/cdn-cgi/trace` å’Œ HTTP Headers (`cf-connecting-ip`) æ¥ç¡®ä¿ç½‘ç»œèº«ä»½çš„çœŸå®æ€§ã€‚è¯·åŠ¡å¿…åœ¨ CF åå°å¼€å¯ "Pseudo IPv4" æˆ–ç¡®ä¿èƒ½é€ä¼ çœŸå® IPã€‚
3. **å†…å­˜é…ç½®**:
Argon2 çš„ `memory_cost` è®¾ä¸º 64MBã€‚è¿™æ„å‘³ç€å¦‚æœæœ‰ 100 ä¸ªå¹¶å‘è¯·æ±‚åŒæ—¶åœ¨æœåŠ¡ç«¯è¿›è¡ŒéªŒè¯ï¼ˆè™½ç„¶éªŒè¯å¾ˆå¿«ï¼‰ï¼Œç†è®ºç¬é—´å³°å€¼å†…å­˜å¯èƒ½è¾ƒé«˜ã€‚ä½†åœ¨ `asyncio.Lock` çš„ä¿æŠ¤ä¸‹ï¼ŒéªŒè¯æ˜¯ä¸²è¡Œçš„ï¼Œå› æ­¤æœåŠ¡ç«¯å†…å­˜å‹åŠ›æå°ï¼Œå‹åŠ›å…¨åœ¨å®¢æˆ·ç«¯ã€‚

## ğŸ“„ License

MIT License
